# CardTrack — API Contract v0.1 (Stack-Agnostic)

This document defines the **HTTP + JSON contract** for integrating the CardTrack frontend with any backend stack (FastAPI / Node / Supabase / etc.).

**Scope:** Profile, Transactions, Recommendations (v1).  
**Non-goals:** Auth, real rewards engine, MCC/FX nuance.

---

## 0. Conventions

### Base URL
- Local dev: `http://localhost:<PORT>`
- API base path: `/api/v1`

### Content Type
- Requests/Responses: `application/json`

### Dates & Formats
- **date**: `YYYY-MM-DD` (e.g., `2026-02-12`)
- **month**: `YYYY-MM` (e.g., `2026-02`)
- **Currency amounts**: SGD numeric (e.g., `100`, `100.5`)

### Standard Error Shape
Any endpoint may return:

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Human-readable message",
    "details": {}
  }
}
```

**Common `error.code` values:**
- `VALIDATION_ERROR`
- `NOT_FOUND`
- `CONFLICT`
- `INTERNAL_ERROR`

---

## 1. Data Models

### 1.1 UserProfile

```json
{
  "user_id": "u_001",
  "username": "demo",
  "preference": "miles",
  "wallet": [
    {
      "card_id": "ww",
      "refresh_day_of_month": 15,
      "annual_fee_billing_date": "2026-06-28",
      "cycle_spend_sgd": 700
    }
  ]
}
```

#### Fields
- `user_id` (string): stable identifier (prototype can use `u_001`)
- `username` (string)
- `preference` (string enum): `miles` | `cashback`
- `wallet` (array of WalletCard)

#### WalletCard fields
- `card_id` (string): must exist in `cards_master.csv`
- `refresh_day_of_month` (int 1–31)
- `annual_fee_billing_date` (string `YYYY-MM-DD`) — required when `card_id` is set
- `cycle_spend_sgd` (number, default 0) — baseline/prior spend:
  - included in spend totals
  - not a transaction
  - excluded from transaction count

---

### 1.2 Transaction

```json
{
  "id": "t_0001",
  "date": "2026-02-12",
  "item": "GrabFood",
  "amount_sgd": 100,
  "card_id": "ww",
  "channel": "online",
  "is_overseas": false
}
```

#### Fields
- `id` (string): generated by server (or client) — unique
- `date` (string `YYYY-MM-DD`): server may default to today if omitted
- `item` (string): required
- `amount_sgd` (number): required, > 0
- `card_id` (string): required; must be in user wallet
- `channel` (string enum): `online` | `offline`
- `is_overseas` (boolean, optional; default `false`)

---

### 1.3 RecommendationRequest

```json
{
  "txn": {
    "item": "GrabFood",
    "amount_sgd": 100,
    "channel": "online",
    "is_overseas": false
  },
  "context": {
    "month": "2026-02"
  }
}
```

#### Fields
- `txn` (object): required
  - `item` (string)
  - `amount_sgd` (number)
  - `channel` (`online` | `offline`)
  - `is_overseas` (boolean, optional)
- `context.month` (optional `YYYY-MM`):
  - if omitted, server uses current month based on server time

**Note:** Backend can derive `userProfile` + transactions from storage using the current user context (prototype assumes single user).

---

### 1.4 RecommendationResult

```json
{
  "recommended_card_id": "ww",
  "ranked_cards": [
    {
      "card_id": "ww",
      "reward_unit": "miles",
      "estimated_reward_value": 400,
      "effective_rate_str": "4.0 mpd",
      "explanations": [
        "You prefer miles, and this is an online transaction.",
        "DBS WW earns 4 mpd on eligible online spend (up to monthly cap).",
        "Baseline (prior spend) contributes to totals but is not a transaction."
      ]
    }
  ],
  "state_snapshot": {
    "target_month": "2026-02"
  }
}
```

#### RankedCard fields
- `card_id` (string)
- `reward_unit` (string enum): `miles` | `cashback`
- `estimated_reward_value` (number): prototype estimate
- `effective_rate_str` (string): e.g., `"4.0 mpd"`, `"3% cashback"`
- `explanations` (string array): 2–5 bullets

#### state_snapshot
- `target_month` (string `YYYY-MM`)

---

## 2. Endpoints

### 2.1 Health

#### `GET /api/v1/health`

Returns service status.

**200 OK**
```json
{
  "status": "ok"
}
```

---

### 2.2 Profile

#### `GET /api/v1/profile`

Returns the current user profile.

**200 OK**
```json
{
  "profile": {
    "user_id": "u_001",
    "username": "demo",
    "preference": "miles",
    "wallet": [
      {
        "card_id": "ww",
        "refresh_day_of_month": 15,
        "annual_fee_billing_date": "2026-06-28",
        "cycle_spend_sgd": 700
      }
    ]
  }
}
```

**404 NOT_FOUND**
```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Profile not found."
  }
}
```

---

#### `POST /api/v1/profile`

Creates or updates the current user profile.

**Request body:**
```json
{
  "profile": {
    "user_id": "u_001",
    "username": "demo",
    "preference": "miles",
    "wallet": [
      {
        "card_id": "ww",
        "refresh_day_of_month": 15,
        "annual_fee_billing_date": "2026-06-28",
        "cycle_spend_sgd": 700
      }
    ]
  }
}
```

**Validation rules:**
- `username` required (non-empty)
- `preference` must be `miles` | `cashback`
- `wallet` must have >= 1 entry
- For each wallet entry:
  - `card_id` required and must exist in `cards_master.csv`
  - if `card_id` is set, `annual_fee_billing_date` required
  - `refresh_day_of_month` must be 1–31
  - `cycle_spend_sgd` must be >= 0

**200 OK**
```json
{
  "profile": {
    "user_id": "u_001",
    "username": "demo",
    "preference": "miles",
    "wallet": [
      {
        "card_id": "ww",
        "refresh_day_of_month": 15,
        "annual_fee_billing_date": "2026-06-28",
        "cycle_spend_sgd": 700
      }
    ]
  }
}
```

**400 VALIDATION_ERROR**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid profile payload.",
    "details": {
      "field": "wallet[0].annual_fee_billing_date",
      "reason": "Required when card_id is set."
    }
  }
}
```

---

### 2.3 Transactions

#### `GET /api/v1/transactions?month=YYYY-MM`

Returns transactions for the selected month.

**Query params:**
- `month` (optional `YYYY-MM`):
  - if omitted: return current month's transactions

**200 OK**
```json
{
  "month": "2026-02",
  "transactions": [
    {
      "id": "t_0001",
      "date": "2026-02-12",
      "item": "GrabFood",
      "amount_sgd": 100,
      "card_id": "ww",
      "channel": "online",
      "is_overseas": false
    }
  ]
}
```

**400 VALIDATION_ERROR**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid month format."
  }
}
```

---

#### `POST /api/v1/transactions`

Creates a new transaction.

**Request body:**
```json
{
  "transaction": {
    "item": "GrabFood",
    "amount_sgd": 100,
    "card_id": "ww",
    "channel": "online",
    "is_overseas": false
  }
}
```

**Notes:**
- Server may generate `id` if missing
- Server may set `date = today` if missing

**Validation rules:**
- `item` required
- `amount_sgd` required and > 0
- `card_id` must be in user wallet
- `channel` must be `online` | `offline`

**201 CREATED**
```json
{
  "transaction": {
    "id": "t_0001",
    "date": "2026-02-12",
    "item": "GrabFood",
    "amount_sgd": 100,
    "card_id": "ww",
    "channel": "online",
    "is_overseas": false
  }
}
```

**400 VALIDATION_ERROR**
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid transaction payload.",
    "details": {
      "field": "amount_sgd",
      "reason": "Must be > 0."
    }
  }
}
```

---

### 2.4 Recommendations

#### `POST /api/v1/recommendations`

Returns ranked card recommendations for a new transaction.

**Request body:**
```json
{
  "request": {
    "txn": {
      "item": "GrabFood",
      "amount_sgd": 100,
      "channel": "online",
      "is_overseas": false
    },
    "context": {
      "month": "2026-02"
    }
  }
}
```

**200 OK**
```json
{
  "result": {
    "recommended_card_id": "ww",
    "ranked_cards": [
      {
        "card_id": "ww",
        "reward_unit": "miles",
        "estimated_reward_value": 400,
        "effective_rate_str": "4.0 mpd",
        "explanations": [
          "You prefer miles and this is an online transaction.",
          "This card provides the highest estimated reward for this spend."
        ]
      }
    ],
    "state_snapshot": {
      "target_month": "2026-02"
    }
  }
}
```

**Validation rules:**
- `request.txn.amount_sgd` > 0
- `request.txn.channel` in `online` | `offline`
- User profile must exist
- Wallet must have >= 1 card

**404 NOT_FOUND**
```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Profile not found."
  }
}
```

---

## 3. Frontend Integration Notes (UI-only → API)

**Current UI uses:**
- LocalStorage `cardtrack_user_profile`
- LocalStorage `cardtrack_transactions`
- Deterministic `getRecommendation()` in frontend

**API integration plan:**
- Introduce a thin `apiClient` in frontend:
  - `getProfile`, `saveProfile`
  - `listTransactions(month)`, `createTransaction(txn)`
  - `getRecommendations(request)`
- Swap LocalStorage + local engine behind the client without changing UI screens.

---

## 4. Versioning

This contract is **v0.1** and intentionally minimal.

Any changes should be additive where possible to avoid frontend churn.